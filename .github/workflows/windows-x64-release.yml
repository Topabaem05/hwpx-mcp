name: Windows x64 Release Build

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing release tag to upload asset (e.g. v0.3.1)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-and-upload:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "electron-ui/package-lock.json"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Resolve release tag
        shell: pwsh
        run: |
          $tag = ""

          if ("${{ github.event_name }}" -eq "push" -and "${{ github.ref_type }}" -eq "tag") {
            $tag = "${{ github.ref_name }}"
          } elseif ("${{ github.event_name }}" -eq "workflow_dispatch" -and "${{ inputs.tag }}" -ne "") {
            $tag = "${{ inputs.tag }}"
          }

          "RELEASE_TAG=$tag" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Install backend build dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e . pyinstaller

      - name: Install Electron dependencies
        working-directory: electron-ui
        shell: pwsh
        run: npm ci

      - name: Build bundled Windows x64 installer
        working-directory: electron-ui
        shell: pwsh
        run: npm run build:win:bundle -- --x64

      - name: Verify bundled backend executable exists
        shell: pwsh
        run: |
          $backendExe = Join-Path $env:GITHUB_WORKSPACE "dist/electron-windows/win-unpacked/resources/backend/hwpx-mcp-backend.exe"
          if (-not (Test-Path $backendExe)) {
            throw "Bundled backend executable missing: $backendExe"
          }

      - name: Normalize release asset name
        shell: pwsh
        run: |
          $outputDir = Join-Path $env:GITHUB_WORKSPACE "dist/electron-windows"
          $installer = Get-ChildItem $outputDir -File -Filter *.exe | Sort-Object LastWriteTime -Descending | Select-Object -First 1

          if (-not $installer) {
            throw "Installer .exe not found in $outputDir"
          }

          $version = if ($env:RELEASE_TAG -ne "") { $env:RELEASE_TAG.TrimStart('v') } else { "dev-$env:GITHUB_RUN_NUMBER" }
          $assetName = "HWPX.MCP-$version-win-x64.exe"
          $assetPath = Join-Path $outputDir $assetName

          Copy-Item -Path $installer.FullName -Destination $assetPath -Force

          "ASSET_NAME=$assetName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "ASSET_PATH=$assetPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-installer
          path: ${{ env.ASSET_PATH }}
          if-no-files-found: error

      - name: Ensure GitHub release exists
        if: env.RELEASE_TAG != ''
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release view "$env:RELEASE_TAG" --repo "$env:GITHUB_REPOSITORY" *> $null
          if ($LASTEXITCODE -ne 0) {
            gh release create "$env:RELEASE_TAG" --title "$env:RELEASE_TAG" --notes "Automated Windows x64 release build." --repo "$env:GITHUB_REPOSITORY"
          }

      - name: Upload asset to GitHub release
        if: env.RELEASE_TAG != ''
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload "$env:RELEASE_TAG" "$env:ASSET_PATH#$env:ASSET_NAME" --clobber --repo "$env:GITHUB_REPOSITORY"
